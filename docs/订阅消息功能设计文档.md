# DIYåˆ›ä½œè®¢é˜…æé†’åŠŸèƒ½è®¾è®¡æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-24  
> **æ›´æ–°æ—¥æœŸ**: 2025-12-24  
> **åŠŸèƒ½æ¦‚è¿°**: å°ç¨‹åºå¯åŠ¨æ—¶æŸ¥è¯¢è®¢é˜…æˆæƒçŠ¶æ€å¹¶ç¼“å­˜ï¼Œç”¨æˆ·ç‚¹å‡»"DIYåˆ›ä½œ"æ—¶æ ¹æ®çŠ¶æ€æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦è¯·æ±‚æˆæƒï¼Œç¡®ä¿ä¸€æ¬¡æ€§è®¢é˜…æ¶ˆè´¹åèƒ½å¤Ÿé‡æ–°è·å–æˆæƒ

---

## ç›®å½•

- [1. åŠŸèƒ½èƒŒæ™¯](#1-åŠŸèƒ½èƒŒæ™¯)
- [2. æŠ€æœ¯æ¶æ„](#2-æŠ€æœ¯æ¶æ„)
- [3. å‰ç«¯å®ç°](#3-å‰ç«¯å®ç°)
- [4. åç«¯å®ç°](#4-åç«¯å®ç°)
- [5. è®¢é˜…æ¶ˆæ¯æœºåˆ¶è¯´æ˜](#5-è®¢é˜…æ¶ˆæ¯æœºåˆ¶è¯´æ˜)
- [6. å®ç°æ¸…å•](#6-å®ç°æ¸…å•)

---

## 1. åŠŸèƒ½èƒŒæ™¯

### 1.1 ä¸šåŠ¡éœ€æ±‚

ç”¨æˆ·åœ¨ç‚¹å‡»"DIYåˆ›ä½œ"æŒ‰é’®æ—¶ï¼Œéœ€è¦è·å–ä¸¤ä¸ªè®¢é˜…æ¶ˆæ¯æƒé™ï¼š
- **æ–°å“å¼€å”®æé†’**: æ¨¡æ¿ID `MKT7vjzg2JVJ2qfuCxwd6n1vD432k9-ICyumG_R8LlU`
- **æ´»åŠ¨å¼€å§‹æé†’**: æ¨¡æ¿ID `A3naddildeEgkTDh_T8nqD5etiklpcwHrTpCLBc6HDs`

### 1.2 äº¤äº’è§„åˆ™

- âœ… å°ç¨‹åºå¯åŠ¨æ—¶æŸ¥è¯¢æˆæƒçŠ¶æ€å¹¶ç¼“å­˜åˆ°å†…å­˜
- âœ… ç‚¹å‡»DIYæ—¶æ ¹æ®ç¼“å­˜çš„æˆæƒçŠ¶æ€æ™ºèƒ½åˆ¤æ–­ï¼š
  - çŠ¶æ€ä¸º `authorized`ï¼ˆå·²æˆæƒæœªæ¶ˆè´¹ï¼‰â†’ ç›´æ¥è·³è½¬ï¼Œä¸å¼¹çª—
  - çŠ¶æ€ä¸º `consumed/expired/rejected`ï¼ˆå·²æ¶ˆè´¹/å·²è¿‡æœŸ/å·²æ‹’ç»ï¼‰â†’ å¼¹å‡ºæˆæƒè¯·æ±‚
  - **æŸ¥è¯¢å¤±è´¥æˆ–æ— çŠ¶æ€** â†’ è§†ä¸ºå·²æˆæƒï¼Œç›´æ¥è·³è½¬ï¼Œä¸å¼¹çª— âš ï¸
- âœ… **æ— è®ºæˆæƒç»“æœ**å¦‚ä½•ï¼Œéƒ½å…è®¸ç”¨æˆ·ç»§ç»­è·³è½¬
- âœ… æˆæƒç»“æœå®æ—¶ä¸ŠæŠ¥åˆ°åç«¯ï¼Œä¿æŒçŠ¶æ€åŒæ­¥

### 1.3 å®¹é”™ç­–ç•¥

**æŸ¥è¯¢æˆæƒçŠ¶æ€å¤±è´¥æ—¶çš„å¤„ç†**ï¼š
- ç½‘ç»œå¼‚å¸¸ã€åç«¯æœåŠ¡å¼‚å¸¸ç­‰å¯¼è‡´æŸ¥è¯¢å¤±è´¥
- é‡‡ç”¨ä¿å®ˆç­–ç•¥ï¼š**é»˜è®¤ä¸æ‰“æ‰°ç”¨æˆ·**
- è§†ä¸ºå·²æˆæƒï¼Œå…è®¸ç”¨æˆ·æ­£å¸¸ä½¿ç”¨DIYåŠŸèƒ½
- é¿å…å› åç«¯é—®é¢˜å½±å“ç”¨æˆ·ä½“éªŒ

### 1.4 è§£å†³çš„æ ¸å¿ƒé—®é¢˜

**ä¸€æ¬¡æ€§è®¢é˜…çš„å±€é™æ€§**ï¼š
- ç”¨æˆ·æˆæƒä¸€æ¬¡åªèƒ½å‘é€ä¸€æ¬¡æ¶ˆæ¯
- æ¶ˆæ¯å‘é€åæˆæƒå¤±æ•ˆ
- å¦‚æœå‰ç«¯ä¸é‡æ–°è¯·æ±‚ï¼Œç”¨æˆ·å°†æ°¸è¿œæ— æ³•æ”¶åˆ°åç»­é€šçŸ¥

**æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- å°ç¨‹åºå¯åŠ¨æ—¶æŸ¥è¯¢åç«¯çš„çœŸå®æˆæƒçŠ¶æ€
- æ ¹æ®çŠ¶æ€åŠ¨æ€å†³å®šæ˜¯å¦éœ€è¦é‡æ–°æˆæƒ
- ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œä½“éªŒæµç•…

---

## 2. æŠ€æœ¯æ¶æ„

### 2.1 å®Œæ•´æˆæƒæµç¨‹

```mermaid
flowchart TD
    Start[å°ç¨‹åºå¯åŠ¨] --> Login[ç™»å½•è·å–token]
    Login --> QueryStatus[æŸ¥è¯¢è®¢é˜…æˆæƒçŠ¶æ€]
    QueryStatus --> CacheStatus[ç¼“å­˜åˆ°State]
    CacheStatus --> ShowHome[æ˜¾ç¤ºé¦–é¡µ]
    
    ShowHome --> UserClick[ç”¨æˆ·ç‚¹å‡»DIY]
    UserClick --> CheckCache{æ£€æŸ¥ç¼“å­˜çŠ¶æ€}
    
    CheckCache -->|authorized<br/>æœªæ¶ˆè´¹| DirectJump[ç›´æ¥è·³è½¬DIY]
    CheckCache -->|consumed/expired<br/>rejected/æœªæˆæƒ| RequestAuth[å¼¹å‡ºæˆæƒè¯·æ±‚]
    
    RequestAuth --> UserChoice{ç”¨æˆ·é€‰æ‹©}
    UserChoice -->|åŒæ„| ReportAuth[ä¸ŠæŠ¥åç«¯]
    UserChoice -->|æ‹’ç»| ReportReject[ä¸ŠæŠ¥æ‹’ç»]
    
    ReportAuth --> UpdateCache[æ›´æ–°ç¼“å­˜çŠ¶æ€]
    ReportReject --> UpdateCache
    UpdateCache --> JumpDIY[è·³è½¬DIY]
    
    DirectJump --> End[ç»“æŸ]
    JumpDIY --> End
```

### 2.2 å‰åç«¯åä½œæ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant MP as å°ç¨‹åºå‰ç«¯
    participant API as åç«¯API
    participant DB as æ•°æ®åº“
    participant WX as å¾®ä¿¡æœåŠ¡å™¨
    
    rect rgb(200, 220, 250)
    note right of User: é˜¶æ®µ1: å¯åŠ¨æ—¶æŸ¥è¯¢çŠ¶æ€
    User->>MP: æ‰“å¼€å°ç¨‹åº
    MP->>API: ç™»å½•è·å–token
    API->>MP: è¿”å›token
    MP->>API: GET /api/user/subscription/status
    API->>DB: æŸ¥è¯¢æˆæƒçŠ¶æ€
    DB->>API: è¿”å›çŠ¶æ€åˆ—è¡¨
    API->>MP: è¿”å›æˆæƒçŠ¶æ€
    MP->>MP: ç¼“å­˜åˆ°å†…å­˜
    end
    
    rect rgb(220, 250, 220)
    note right of User: é˜¶æ®µ2: ç‚¹å‡»DIYæ™ºèƒ½åˆ¤æ–­
    User->>MP: ç‚¹å‡»DIYåˆ›ä½œ
    MP->>MP: æ£€æŸ¥ç¼“å­˜çš„æˆæƒçŠ¶æ€
    alt çŠ¶æ€ä¸º authorized (æœªæ¶ˆè´¹)
        MP->>User: ç›´æ¥è·³è½¬DIYé¡µé¢
    else çŠ¶æ€éœ€è¦é‡æ–°æˆæƒ
        MP->>User: å¼¹å‡ºè®¢é˜…æˆæƒ
        User->>MP: åŒæ„/æ‹’ç»è®¢é˜…
        MP->>API: POST /api/user/subscription
        API->>DB: ä¿å­˜æˆæƒçŠ¶æ€
        API->>MP: è¿”å›æˆåŠŸ
        MP->>MP: æ›´æ–°ç¼“å­˜ + è·³è½¬DIY
    end
    end
    
    rect rgb(250, 220, 200)
    note right of User: é˜¶æ®µ3: åç«¯å‘é€
    API->>API: è§¦å‘äº‹ä»¶(æ–°å“ä¸Šæ¶/æ´»åŠ¨å¼€å§‹)
    API->>DB: æŸ¥è¯¢å·²æˆæƒç”¨æˆ·
    DB->>API: è¿”å›ç”¨æˆ·åˆ—è¡¨
    loop éå†å·²æˆæƒç”¨æˆ·
        API->>WX: è°ƒç”¨å‘é€è®¢é˜…æ¶ˆæ¯API
        WX->>User: æ¨é€è®¢é˜…æ¶ˆæ¯
        WX->>API: è¿”å›ç»“æœ
        alt å‘é€æˆåŠŸ
            API->>DB: æ ‡è®°æˆæƒå·²æ¶ˆè´¹
        else æˆæƒå¤±æ•ˆ
            API->>DB: æ ‡è®°æˆæƒè¿‡æœŸ
        end
    end
    end
```

---

## 3. å‰ç«¯å®ç°

### 3.1 æ·»åŠ è®¢é˜…æ¶ˆæ¯æ¨¡æ¿ ID é…ç½®

**æ–‡ä»¶**: `src/config/index.ts`

åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼š

```typescript
// è®¢é˜…æ¶ˆæ¯æ¨¡æ¿ ID
export const SUBSCRIPTION_NEW_PRODUCT_TEMPLATE_ID = "MKT7vjzg2JVJ2qfuCxwd6n1vD432k9-ICyumG_R8LlU"; // æ–°å“å¼€å”®æé†’
export const SUBSCRIPTION_ACTIVITY_TEMPLATE_ID = "A3naddildeEgkTDh_T8nqD5etiklpcwHrTpCLBc6HDs"; // æ´»åŠ¨å¼€å§‹æé†’
```

### 3.2 æ·»åŠ  API æ¥å£

**æ–‡ä»¶**: `src/utils/api.ts`

åœ¨ `userApi` å¯¹è±¡ä¸­æ·»åŠ ä¸¤ä¸ªæ–°æ–¹æ³•ï¼š

```typescript
// æŸ¥è¯¢ç”¨æˆ·è®¢é˜…æˆæƒçŠ¶æ€
getSubscriptionStatus: (data: {
  templateIds: string[];
  showLoading?: boolean;
  showError?: boolean;
}) => request({
  url: '/user/subscription/status',
  method: 'GET',
  data: { template_ids: data.templateIds.join(',') },
  showLoading: data.showLoading,
  showError: data.showError,
}),

// ä¸ŠæŠ¥ç”¨æˆ·è®¢é˜…æˆæƒç»“æœ
reportSubscription: (data: {
  subscriptions: Record<string, string>;
  showLoading?: boolean;
  showError?: boolean;
}) => request({
  url: '/user/subscription',
  method: 'POST',
  data: data.subscriptions,
  showLoading: data.showLoading,
  showError: data.showError,
}),
```

### 3.3 åœ¨å°ç¨‹åºå¯åŠ¨æ—¶æŸ¥è¯¢æˆæƒçŠ¶æ€

**æ–‡ä»¶**: `src/pages/home/index.tsx`

#### æ·»åŠ çŠ¶æ€ç®¡ç†

åœ¨ç»„ä»¶é¡¶éƒ¨æ·»åŠ çŠ¶æ€ï¼š

```typescript
const [subscriptionStatus, setSubscriptionStatus] = useState<Record<string, string>>({});
```

#### åœ¨ `useLoad` ä¸­æŸ¥è¯¢æˆæƒçŠ¶æ€

ä¿®æ”¹ç°æœ‰çš„ `useLoad` é’©å­ï¼Œåœ¨ç™»å½•æˆåŠŸåæŸ¥è¯¢æˆæƒçŠ¶æ€ï¼š

```typescript
useLoad((options) => {
  const code = options.code;
  
  const initializeApp = async () => {
    try {
      // 1. æ¸…é™¤æ—§çš„è®¤è¯å¹¶é‡æ–°ç™»å½•
      AuthManager.clearAuth();
      await AuthManager.login(code);
      console.log("âœ… ç™»å½•æˆåŠŸ");

      if (code) {
        Taro.showToast({
          title: `é€šè¿‡åˆ†äº«ç ${code}è¿›å…¥ï¼`,
          icon: "none",
          duration: 2000,
        });
      }

      // 2. è·å–ç”¨æˆ·ä¿¡æ¯å’Œåˆ†äº«ç 
      const res = await userApi.getUserInfo({ 
        showLoading: false, 
        showError: false 
      });
      const user = res.data as any;
      if (user && user.is_promo_enable) {
        console.log("âœ… è·å–åˆ°åˆ†äº«ç :", user.promo_code);
        setInvitationCode(user.promo_code);
      }

      // 3. âœ¨ æŸ¥è¯¢è®¢é˜…æˆæƒçŠ¶æ€
      try {
        const statusRes = await userApi.getSubscriptionStatus({
          templateIds: [
            SUBSCRIPTION_NEW_PRODUCT_TEMPLATE_ID,
            SUBSCRIPTION_ACTIVITY_TEMPLATE_ID
          ],
          showLoading: false,
          showError: false
        });
        
        // å°†çŠ¶æ€è½¬æ¢ä¸º Map ä¾¿äºæŸ¥è¯¢
        const statusMap: Record<string, string> = {};
        statusRes.data.forEach((item: any) => {
          statusMap[item.template_id] = item.status;
        });
        
  setSubscriptionStatus(statusMap);
  console.log("âœ… è®¢é˜…çŠ¶æ€å·²åŠ è½½:", statusMap);
} catch (error) {
  console.error("âŒ æŸ¥è¯¢è®¢é˜…çŠ¶æ€å¤±è´¥:", error);
  // æŸ¥è¯¢å¤±è´¥ä¿æŒç©ºå¯¹è±¡ï¼Œåç»­ä¸ä¼šè¯·æ±‚æˆæƒï¼ˆå®¹é”™ç­–ç•¥ï¼‰
  setSubscriptionStatus({});
}

      // 4. åˆå§‹åŒ–å®Œæˆåæ˜¾ç¤ºåˆ†äº«èœå•
      Taro.showShareMenu({
        withShareTicket: true,
        showShareItems: ["shareAppMessage", "shareTimeline"],
      });
    } catch (error) {
      console.error("âŒ åˆå§‹åŒ–å¤±è´¥:", error);
      setInvitationCode("");
      // å³ä½¿å¤±è´¥ä¹Ÿæ˜¾ç¤ºåˆ†äº«èœå•
      Taro.showShareMenu({
        withShareTicket: true,
        showShareItems: ["shareAppMessage", "shareTimeline"],
      });
    }
  };

  initializeApp();
});
```

### 3.4 ä¿®æ”¹ DIY åˆ›ä½œæŒ‰é’®ç‚¹å‡»é€»è¾‘

**æ–‡ä»¶**: `src/pages/home/index.tsx`

#### æ·»åŠ åˆ¤æ–­è¾…åŠ©å‡½æ•°

åœ¨ç»„ä»¶ä¸­æ·»åŠ è¾…åŠ©å‡½æ•°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°æˆæƒï¼š

```typescript
// åˆ¤æ–­æ˜¯å¦éœ€è¦è¯·æ±‚è®¢é˜…æˆæƒ
const needSubscriptionAuthorization = () => {
  // å¦‚æœçŠ¶æ€ä¸ºç©ºå¯¹è±¡ï¼Œè¯´æ˜æŸ¥è¯¢å¤±è´¥ï¼Œé»˜è®¤ä¸è¯·æ±‚æˆæƒï¼ˆå®¹é”™ï¼‰
  if (Object.keys(subscriptionStatus).length === 0) {
    return false;
  }
  
  const checkStatus = (templateId: string) => {
    const status = subscriptionStatus[templateId];
    // åªæœ‰æ˜ç¡®çš„éœ€è¦é‡æ–°æˆæƒçŠ¶æ€æ‰è¿”å› true
    return status === 'consumed' || 
           status === 'expired' || 
           status === 'rejected' ||
           status === 'not_authorized';
  };
  
  return checkStatus(SUBSCRIPTION_NEW_PRODUCT_TEMPLATE_ID) ||
         checkStatus(SUBSCRIPTION_ACTIVITY_TEMPLATE_ID);
};
```

#### å½“å‰å®ç°ï¼ˆç¬¬ 278-285 è¡Œï¼‰

```typescript
onClick={() => {
  Taro.reportEvent("homepage_event", { home_diy_click: 1 });
  Taro.redirectTo({
    url: pageUrls.customDesign + "?from=home",
  });
}}
```

#### æ”¹é€ åçš„å®ç°

```typescript
onClick={async () => {
  Taro.reportEvent("homepage_event", { home_diy_click: 1 });
  
  // æ ¹æ®ç¼“å­˜çš„æˆæƒçŠ¶æ€åˆ¤æ–­æ˜¯å¦éœ€è¦è¯·æ±‚æˆæƒ
  if (needSubscriptionAuthorization()) {
    try {
      // 1. è¯·æ±‚è®¢é˜…æˆæƒ
      const result = await ensureSubscribe({
        templateIds: [
          SUBSCRIPTION_NEW_PRODUCT_TEMPLATE_ID,
          SUBSCRIPTION_ACTIVITY_TEMPLATE_ID
        ],
        includeAlwaysAccept: true
      });
      
      // 2. ä¸ŠæŠ¥æˆæƒç»“æœåˆ°åç«¯
      if (result.requested && result.result) {
        await userApi.reportSubscription({
          subscriptions: result.result,
          showLoading: false,
          showError: false
        });
        
        // 3. æ›´æ–°æœ¬åœ°ç¼“å­˜çš„çŠ¶æ€
        const newStatus = { ...subscriptionStatus };
        Object.keys(result.result).forEach(templateId => {
          if (result.result[templateId] === 'accept') {
            newStatus[templateId] = 'authorized';
          } else if (result.result[templateId] === 'reject') {
            newStatus[templateId] = 'rejected';
          }
        });
        setSubscriptionStatus(newStatus);
        console.log("âœ… è®¢é˜…çŠ¶æ€å·²æ›´æ–°:", newStatus);
      }
    } catch (error) {
      console.error('è®¢é˜…æµç¨‹å¤±è´¥:', error);
    }
  }
  
  // è·³è½¬ï¼ˆæ— è®ºæˆæƒç»“æœï¼‰
  Taro.redirectTo({
    url: pageUrls.customDesign + "?from=home",
  });
}}
```

#### æ·»åŠ å¯¼å…¥è¯­å¥ï¼ˆæ–‡ä»¶é¡¶éƒ¨ï¼‰

```typescript
import { ensureSubscribe } from '@/utils/messageUtils';
import { SUBSCRIPTION_NEW_PRODUCT_TEMPLATE_ID, SUBSCRIPTION_ACTIVITY_TEMPLATE_ID } from '@/config';
```

### 3.5 å…³é”®æŠ€æœ¯ç‚¹

| æŠ€æœ¯ç‚¹ | è¯´æ˜ |
|--------|------|
| **çŠ¶æ€ç¼“å­˜** | ä½¿ç”¨ React State ç¼“å­˜æˆæƒçŠ¶æ€ï¼ˆå†…å­˜çº§åˆ«ï¼‰ |
| **å¯åŠ¨æ—¶æŸ¥è¯¢** | åœ¨ `useLoad` é’©å­ä¸­æŸ¥è¯¢ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥ |
| **æ™ºèƒ½åˆ¤æ–­** | æ ¹æ®ç¼“å­˜çŠ¶æ€åŠ¨æ€å†³å®šæ˜¯å¦å¼¹çª— |
| **å®¹é”™ç­–ç•¥** | æŸ¥è¯¢å¤±è´¥æ—¶é»˜è®¤ä¸æ‰“æ‰°ç”¨æˆ· âš ï¸ |
| **è®¢é˜…å·¥å…·** | ä½¿ç”¨é¡¹ç›®ç°æœ‰çš„ `ensureSubscribe()` å‡½æ•° |
| **çŠ¶æ€åŒæ­¥** | æˆæƒåç«‹å³æ›´æ–°ç¼“å­˜å’Œåç«¯ |
| **ç”¨æˆ·ä½“éªŒ** | æ— è®ºæˆæƒç»“æœéƒ½å…è®¸è·³è½¬ |

### 3.6 ä¾èµ–çš„ç°æœ‰å·¥å…·

é¡¹ç›®ä¸­å·²å®ç°çš„ `ensureSubscribe()` å‡½æ•°ï¼ˆä½äº `src/utils/messageUtils.ts`ï¼‰ï¼š
- è‡ªåŠ¨å¤„ç†ç”¨æˆ·çš„å›ºå®šé€‰æ‹©ï¼ˆ"æ€»æ˜¯ä¿æŒä»¥ä¸Šï¼Œä¸å†è¯¢é—®"ï¼‰
- æ™ºèƒ½åˆ¤æ–­å“ªäº›æ¨¡æ¿éœ€è¦å¼¹çª—è¯·æ±‚
- è¿”å›æ ‡å‡†åŒ–çš„æˆæƒç»“æœ

### 3.7 ä¸ºä»€ä¹ˆä¸ä½¿ç”¨æœ¬åœ°æŒä¹…åŒ–å­˜å‚¨ï¼Ÿ

**ä¹‹å‰çš„é—®é¢˜**ï¼š
- ä½¿ç”¨ `Taro.setStorageSync` å­˜å‚¨ç®€å•çš„å¸ƒå°”æ ‡è®°
- ä¸€æ—¦æ ‡è®°ä¸º"å·²è¯·æ±‚"ï¼Œæ°¸è¿œä¸ä¼šå†è¯·æ±‚
- å³ä½¿æˆæƒè¢«æ¶ˆè´¹ï¼Œä¹Ÿæ— æ³•é‡æ–°è·å–

**ç°åœ¨çš„æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨å†…å­˜çº§åˆ«çš„ State ç¼“å­˜
- æ¯æ¬¡å¯åŠ¨éƒ½ä»åç«¯è·å–æœ€æ–°çŠ¶æ€
- ç¡®ä¿çŠ¶æ€ä¸åç«¯æ•°æ®åº“ä¿æŒåŒæ­¥

### 3.8 é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶

#### æŸ¥è¯¢æˆæƒçŠ¶æ€å¤±è´¥

**åœºæ™¯**ï¼š
- ç½‘ç»œå¼‚å¸¸
- åç«¯æœåŠ¡å¼‚å¸¸
- æ¥å£è¶…æ—¶

**å¤„ç†ç­–ç•¥**ï¼š
```typescript
try {
  // æŸ¥è¯¢æˆæƒçŠ¶æ€
  const statusRes = await userApi.getSubscriptionStatus({...});
  setSubscriptionStatus(statusMap);
} catch (error) {
  // å¤±è´¥æ—¶è®¾ç½®ä¸ºç©ºå¯¹è±¡
  setSubscriptionStatus({});
  console.error("æŸ¥è¯¢æˆæƒçŠ¶æ€å¤±è´¥:", error);
}
```

**ç»“æœ**ï¼š
- `subscriptionStatus` ä¸ºç©ºå¯¹è±¡ `{}`
- `needSubscriptionAuthorization()` è¿”å› `false`
- ç”¨æˆ·ç‚¹å‡»DIYæ—¶**ä¸ä¼šå¼¹å‡ºæˆæƒè¯·æ±‚**
- ä¿éšœç”¨æˆ·æ­£å¸¸ä½¿ç”¨åŠŸèƒ½

#### åˆ¤æ–­é€»è¾‘

```typescript
const needSubscriptionAuthorization = () => {
  // ğŸ”´ å…³é”®ï¼šç©ºå¯¹è±¡è¡¨ç¤ºæŸ¥è¯¢å¤±è´¥ï¼Œé»˜è®¤ä¸è¯·æ±‚æˆæƒ
  if (Object.keys(subscriptionStatus).length === 0) {
    return false;
  }
  
  // ... å…¶ä»–åˆ¤æ–­é€»è¾‘
};
```

**è®¾è®¡ç†å¿µ**ï¼š
- âœ… **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**ï¼šå®å¯å°‘æ‰“æ‰°ï¼Œä¹Ÿä¸å½±å“åŠŸèƒ½
- âœ… **é™çº§ç­–ç•¥**ï¼šåç«¯å¼‚å¸¸æ—¶å‰ç«¯ä»å¯æ­£å¸¸ä½¿ç”¨
- âš ï¸ **æƒè¡¡**ï¼šå¯èƒ½é”™è¿‡éƒ¨åˆ†æˆæƒæœºä¼šï¼Œä½†ä¿éšœäº†æ ¸å¿ƒåŠŸèƒ½

---

## 4. åç«¯å®ç°

### 4.1 æ•°æ®åº“è®¾è®¡

åˆ›å»ºç”¨æˆ·è®¢é˜…æˆæƒè¡¨ï¼š

```sql
CREATE TABLE user_subscriptions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    openid VARCHAR(64) NOT NULL COMMENT 'å¾®ä¿¡openid',
    template_id VARCHAR(100) NOT NULL COMMENT 'æ¨¡æ¿ID',
    
    -- æˆæƒçŠ¶æ€
    status ENUM('authorized', 'consumed', 'expired', 'rejected') DEFAULT 'authorized'
        COMMENT 'authorized:å·²æˆæƒ consumed:å·²æ¶ˆè´¹ expired:å·²è¿‡æœŸ rejected:ç”¨æˆ·æ‹’ç»',
    
    -- æˆæƒç±»å‹
    auth_type ENUM('once', 'always') DEFAULT 'once'
        COMMENT 'once:ä¸€æ¬¡æ€§æˆæƒ always:é•¿æœŸæˆæƒ',
    
    -- æ—¶é—´è®°å½•
    authorized_at DATETIME COMMENT 'æˆæƒæ—¶é—´',
    consumed_at DATETIME COMMENT 'æ¶ˆè´¹æ—¶é—´',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    UNIQUE KEY uk_user_template (user_id, template_id),
    INDEX idx_openid (openid),
    INDEX idx_status (status),
    INDEX idx_template (template_id)
) COMMENT='ç”¨æˆ·è®¢é˜…æ¶ˆæ¯æˆæƒè¡¨';
```

#### å­—æ®µè¯´æ˜

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `status` | `authorized`: å·²æˆæƒ<br>`consumed`: å·²æ¶ˆè´¹ï¼ˆä¸€æ¬¡æ€§æˆæƒå‘é€åï¼‰<br>`expired`: å·²è¿‡æœŸ<br>`rejected`: ç”¨æˆ·æ‹’ç» |
| `auth_type` | `once`: ä¸€æ¬¡æ€§æˆæƒ<br>`always`: é•¿æœŸæˆæƒ |

### 4.2 æŸ¥è¯¢æˆæƒçŠ¶æ€æ¥å£ âœ¨ æ–°å¢

#### æ¥å£è§„èŒƒ

- **è·¯å¾„**: `GET /api/user/subscription/status`
- **è®¤è¯**: éœ€è¦ token
- **è¯·æ±‚å‚æ•°**: `template_ids` (é€—å·åˆ†éš”çš„æ¨¡æ¿IDåˆ—è¡¨)

#### è¯·æ±‚ç¤ºä¾‹

```http
GET /api/user/subscription/status?template_ids=MKT7vjzg2JVJ2qfuCxwd6n1vD432k9-ICyumG_R8LlU,A3naddildeEgkTDh_T8nqD5etiklpcwHrTpCLBc6HDs
Authorization: Bearer <token>
```

#### å“åº”ç¤ºä¾‹

```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "template_id": "MKT7vjzg2JVJ2qfuCxwd6n1vD432k9-ICyumG_R8LlU",
      "status": "consumed",
      "auth_type": "once",
      "authorized_at": "2025-12-20 10:00:00",
      "consumed_at": "2025-12-22 15:30:00"
    },
    {
      "template_id": "A3naddildeEgkTDh_T8nqD5etiklpcwHrTpCLBc6HDs",
      "status": "authorized",
      "auth_type": "once",
      "authorized_at": "2025-12-20 10:00:00",
      "consumed_at": null
    }
  ]
}
```

#### çŠ¶æ€è¯´æ˜

| çŠ¶æ€å€¼ | å«ä¹‰ | å‰ç«¯å¤„ç† |
|--------|------|----------|
| `authorized` | å·²æˆæƒï¼Œæœªæ¶ˆè´¹ | âœ… ä¸éœ€è¦é‡æ–°æˆæƒ |
| `consumed` | å·²æ¶ˆè´¹ï¼ˆä¸€æ¬¡æ€§æˆæƒå·²ä½¿ç”¨ï¼‰ | âŒ éœ€è¦é‡æ–°æˆæƒ |
| `expired` | å·²è¿‡æœŸ | âŒ éœ€è¦é‡æ–°æˆæƒ |
| `rejected` | ç”¨æˆ·æ‹’ç» | âŒ éœ€è¦é‡æ–°æˆæƒ |
| `not_authorized` | ä»æœªæˆæƒ | âŒ éœ€è¦é‡æ–°æˆæƒ |
| ï¼ˆæŸ¥è¯¢å¤±è´¥/æ— çŠ¶æ€ï¼‰ | ç½‘ç»œå¼‚å¸¸æˆ–åç«¯å¼‚å¸¸ | âœ… ä¸è¯·æ±‚æˆæƒï¼ˆå®¹é”™ï¼‰ |

#### åç«¯å®ç°ç¤ºä¾‹

```python
@app.get("/api/user/subscription/status")
async def get_subscription_status(
    template_ids: str, 
    user_id: int = Depends(get_current_user)
):
    """æŸ¥è¯¢ç”¨æˆ·çš„è®¢é˜…æˆæƒçŠ¶æ€"""
    
    template_id_list = template_ids.split(',')
    results = []
    
    for template_id in template_id_list:
        # æŸ¥è¯¢æ•°æ®åº“æœ€æ–°è®°å½•
        record = db.query("""
            SELECT template_id, status, auth_type, authorized_at, consumed_at
            FROM user_subscriptions
            WHERE user_id = %s AND template_id = %s
            ORDER BY created_at DESC
            LIMIT 1
        """, [user_id, template_id])
        
        if record:
            results.append(record)
        else:
            # æœªæ‰¾åˆ°è®°å½•ï¼Œè¡¨ç¤ºä»æœªæˆæƒ
            results.append({
                "template_id": template_id,
                "status": "not_authorized",
                "auth_type": None,
                "authorized_at": None,
                "consumed_at": None
            })
    
    return {"code": 0, "message": "success", "data": results}
```

### 4.3 æ¥æ”¶æˆæƒç»“æœæ¥å£

#### æ¥å£è§„èŒƒ

- **è·¯å¾„**: `POST /api/user/subscription`
- **è®¤è¯**: éœ€è¦ token
- **Content-Type**: `application/json`

#### è¯·æ±‚ä½“ç¤ºä¾‹

```json
{
  "MKT7vjzg2JVJ2qfuCxwd6n1vD432k9-ICyumG_R8LlU": "accept",
  "A3naddildeEgkTDh_T8nqD5etiklpcwHrTpCLBc6HDs": "reject"
}
```

#### å¤„ç†é€»è¾‘

1. ä» token ä¸­æå– `user_id` å’Œ `openid`
2. éå†è®¢é˜…ç»“æœï¼ˆ`key` ä¸ºæ¨¡æ¿IDï¼Œ`value` ä¸ºç”¨æˆ·é€‰æ‹©ï¼‰
3. æ ¹æ®ç”¨æˆ·é€‰æ‹©ä¿å­˜åˆ°æ•°æ®åº“ï¼š
   - `accept` â†’ ä¿å­˜ä¸º `authorized` çŠ¶æ€
   - `reject` â†’ ä¿å­˜ä¸º `rejected` çŠ¶æ€
   - `ban` â†’ ä¿å­˜ä¸º `expired` çŠ¶æ€

#### å“åº”ç¤ºä¾‹

```json
{
  "code": 0,
  "message": "success"
}
```

### 4.4 å‘é€è®¢é˜…æ¶ˆæ¯

#### è§¦å‘æ—¶æœº

- æ–°å“ä¸Šæ¶
- æ´»åŠ¨å¼€å§‹

#### å‘é€æµç¨‹

```python
async def send_new_product_notification(product_id: int):
    """æ–°å“ä¸Šæ¶æ—¶å‘é€è®¢é˜…æ¶ˆæ¯"""
    
    template_id = "MKT7vjzg2JVJ2qfuCxwd6n1vD432k9-ICyumG_R8LlU"
    
    # 1. æŸ¥è¯¢å·²æˆæƒçš„ç”¨æˆ·
    authorized_users = db.query("""
        SELECT user_id, openid 
        FROM user_subscriptions 
        WHERE template_id = %s 
        AND status = 'authorized'
    """, [template_id])
    
    # 2. è·å–æ–°å“ä¿¡æ¯
    product = get_product_info(product_id)
    
    # 3. æ‰¹é‡å‘é€
    for user in authorized_users:
        result = await send_subscribe_message(
            openid=user['openid'],
            template_id=template_id,
            page=f"pages-product/product-detail/index?id={product_id}",
            data={
                "thing1": {"value": product['name'][:20]},
                "time2": {"value": product['launch_time']},
                "thing3": {"value": "ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…"}
            }
        )
        
        # 4. æ›´æ–°æˆæƒçŠ¶æ€
        if result['errcode'] == 0:
            # å‘é€æˆåŠŸï¼Œæ ‡è®°ä¸ºå·²æ¶ˆè´¹
            update_status(user['user_id'], template_id, 'consumed')
        elif result['errcode'] == 43101:
            # æˆæƒå¤±æ•ˆ
            update_status(user['user_id'], template_id, 'expired')
```

#### å¾®ä¿¡ API è°ƒç”¨

```http
POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=TOKEN

Content-Type: application/json

{
  "touser": "OPENID",
  "template_id": "MKT7vjzg2JVJ2qfuCxwd6n1vD432k9-ICyumG_R8LlU",
  "page": "pages-product/product-detail/index?id=123",
  "data": {
    "thing1": {"value": "æ–°å“åç§°"},
    "time2": {"value": "2025-12-24 10:00"},
    "thing3": {"value": "ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…"}
  },
  "miniprogram_state": "formal"
}
```

#### å¾®ä¿¡ API å“åº”

æˆåŠŸï¼š
```json
{
  "errcode": 0,
  "errmsg": "ok"
}
```

å¤±è´¥ï¼š
```json
{
  "errcode": 43101,
  "errmsg": "user refuse to accept the msg hint"
}
```

#### å¸¸è§é”™è¯¯ç 

| é”™è¯¯ç  | è¯´æ˜ | å¤„ç†æ–¹å¼ |
|--------|------|----------|
| 0 | å‘é€æˆåŠŸ | æ ‡è®°ä¸º `consumed` |
| 43101 | ç”¨æˆ·æ‹’ç»æˆ–æˆæƒå·²å¤±æ•ˆ | æ ‡è®°ä¸º `expired` |
| 47003 | æ¨¡æ¿å‚æ•°ä¸å‡†ç¡® | æ£€æŸ¥å‚æ•°æ ¼å¼ |
| 41030 | page è·¯å¾„ä¸æ­£ç¡® | æ£€æŸ¥è·³è½¬è·¯å¾„ |

### 4.5 å‘é€ç­–ç•¥å»ºè®®

#### âŒ ä¸æ¨èï¼šå‘æ‰€æœ‰ç”¨æˆ·æ— å·®åˆ«å‘é€

```python
# é”™è¯¯åšæ³•
for user in all_users:
    send_message(user.openid, template_id)  # ä¼šäº§ç”Ÿå¤§é‡æ— æ•ˆè°ƒç”¨
```

#### âœ… æ¨èï¼šç»´æŠ¤æˆæƒçŠ¶æ€ï¼Œæ™ºèƒ½è¿‡æ»¤

```python
# æ­£ç¡®åšæ³•
authorized_users = get_authorized_users(template_id)  # åªæŸ¥è¯¢å·²æˆæƒç”¨æˆ·
for user in authorized_users:
    send_message(user.openid, template_id)
```

#### æ‰¹é‡å‘é€ä¼˜åŒ–

```python
# åˆ†æ‰¹å‘é€ + é™æµ
async def batch_send_with_rate_limit(users: List[Dict], batch_size=100):
    for i in range(0, len(users), batch_size):
        batch = users[i:i+batch_size]
        
        # å¹¶å‘å‘é€å½“å‰æ‰¹æ¬¡
        tasks = [send_to_user(user) for user in batch]
        await asyncio.gather(*tasks)
        
        # æ‰¹æ¬¡é—´å»¶è¿Ÿï¼Œé¿å…è§¦å‘å¾®ä¿¡é™æµ
        if i + batch_size < len(users):
            await asyncio.sleep(1)
```

---

## 5. è®¢é˜…æ¶ˆæ¯æœºåˆ¶è¯´æ˜

### 5.1 æˆæƒæœºåˆ¶

#### ä¸€æ¬¡æ€§è®¢é˜…ï¼ˆé»˜è®¤ï¼‰

- ç”¨æˆ·æˆæƒä¸€æ¬¡ = å¯å‘é€ä¸€æ¬¡æ¶ˆæ¯
- åç«¯å‘é€æ¶ˆæ¯åï¼Œæˆæƒè‡ªåŠ¨å¤±æ•ˆ
- ä¸‹æ¬¡å‘é€éœ€è¦ç”¨æˆ·é‡æ–°æˆæƒ

#### é•¿æœŸè®¢é˜…

- ç”¨æˆ·åœ¨æˆæƒå¼¹çª—ä¸­ç‚¹å‡» **"æ€»æ˜¯ä¿æŒä»¥ä¸Šï¼Œä¸å†è¯¢é—®"**
- æˆæƒæ°¸ä¹…æœ‰æ•ˆï¼ˆé™¤éç”¨æˆ·æ‰‹åŠ¨å…³é—­ï¼‰
- åç«¯å¯ä»¥åå¤å‘é€æ¶ˆæ¯

### 5.2 å‰ç«¯ vs åç«¯èŒè´£

| è§’è‰² | èŒè´£ | èƒ½åŠ›é™åˆ¶ |
|------|------|----------|
| **å‰ç«¯** | è¯·æ±‚ç”¨æˆ·æˆæƒ | âŒ ä¸èƒ½å‘é€è®¢é˜…æ¶ˆæ¯ |
| **åç«¯** | å‘é€è®¢é˜…æ¶ˆæ¯ | âŒ ä¸èƒ½è¯·æ±‚ç”¨æˆ·æˆæƒ |

### 5.3 å¾®ä¿¡çš„äºŒæ¬¡éªŒè¯

å³ä½¿åç«¯ç»´æŠ¤äº†æˆæƒçŠ¶æ€ï¼Œ**å¾®ä¿¡æœåŠ¡å™¨ä»ä¼šäºŒæ¬¡éªŒè¯**ï¼š
- ç”¨æˆ·æœªæˆæƒ â†’ è¿”å›é”™è¯¯ç  43101
- ä¸€æ¬¡æ€§æˆæƒå·²æ¶ˆè´¹ â†’ è¿”å›é”™è¯¯ç  43101
- ç”¨æˆ·å…³é—­äº†é•¿æœŸæˆæƒ â†’ è¿”å›é”™è¯¯ç  43101

å› æ­¤ï¼Œå»ºè®®ï¼š
1. **åç«¯ç»´æŠ¤æˆæƒè¡¨** - å‡å°‘æ— æ•ˆ API è°ƒç”¨
2. **å¤„ç†å¾®ä¿¡é”™è¯¯ç ** - æ ¹æ®è¿”å›ç»“æœæ›´æ–°æˆæƒçŠ¶æ€

---

## 6. å®ç°æ¸…å•

### 6.1 å‰ç«¯å¼€å‘ä»»åŠ¡

- [ ] åœ¨ `config/index.ts` æ·»åŠ è®¢é˜…æ¶ˆæ¯æ¨¡æ¿ ID å¸¸é‡
- [ ] åœ¨ `utils/api.ts` æ·»åŠ ä¸¤ä¸ªæ¥å£ï¼š
  - [ ] `getSubscriptionStatus` - æŸ¥è¯¢æˆæƒçŠ¶æ€
  - [ ] `reportSubscription` - ä¸ŠæŠ¥æˆæƒç»“æœ
- [ ] ä¿®æ”¹ `pages/home/index.tsx`ï¼š
  - [ ] æ·»åŠ çŠ¶æ€ç®¡ç† `subscriptionStatus`
  - [ ] åœ¨ `useLoad` ä¸­æŸ¥è¯¢æˆæƒçŠ¶æ€å¹¶ç¼“å­˜
  - [ ] æ·»åŠ åˆ¤æ–­è¾…åŠ©å‡½æ•° `needSubscriptionAuthorization`
  - [ ] ä¿®æ”¹ DIY æŒ‰é’®ç‚¹å‡»é€»è¾‘ï¼ˆæ ¹æ®ç¼“å­˜çŠ¶æ€åˆ¤æ–­ï¼‰
  - [ ] æ·»åŠ å¿…è¦çš„å¯¼å…¥è¯­å¥
- [ ] æµ‹è¯•ä¸åŒåœºæ™¯ï¼š
  - [ ] é¦–æ¬¡ä½¿ç”¨ï¼ˆä»æœªæˆæƒï¼‰
  - [ ] æˆæƒåæœªæ¶ˆè´¹ï¼ˆç›´æ¥è·³è½¬ï¼‰
  - [ ] æˆæƒå·²æ¶ˆè´¹ï¼ˆé‡æ–°è¯·æ±‚ï¼‰
  - [ ] ç”¨æˆ·æ‹’ç»æˆæƒï¼ˆä¸‹æ¬¡ä»ä¼šè¯·æ±‚ï¼‰

### 6.2 åç«¯å¼€å‘ä»»åŠ¡

- [ ] åˆ›å»ºæ•°æ®åº“è¡¨ `user_subscriptions`
- [ ] å®ç°æ¥å£ `GET /api/user/subscription/status` âœ¨ æ–°å¢
  - [ ] æŸ¥è¯¢ç”¨æˆ·çš„æˆæƒçŠ¶æ€
  - [ ] å¤„ç†æœªæˆæƒçš„æƒ…å†µ
- [ ] å®ç°æ¥å£ `POST /api/user/subscription`
  - [ ] æ¥æ”¶å¹¶ä¿å­˜æˆæƒç»“æœ
  - [ ] æ›´æ–°ç°æœ‰è®°å½•æˆ–æ’å…¥æ–°è®°å½•
- [ ] å®ç°å‘é€è®¢é˜…æ¶ˆæ¯çš„åŠŸèƒ½ï¼ˆæ–°å“ä¸Šæ¶æ—¶ï¼‰
  - [ ] æŸ¥è¯¢ `status='authorized'` çš„ç”¨æˆ·
  - [ ] è°ƒç”¨å¾®ä¿¡ API å‘é€
  - [ ] æ ¹æ®è¿”å›ç»“æœæ›´æ–°çŠ¶æ€ä¸º `consumed` æˆ– `expired`
- [ ] å®ç°å‘é€è®¢é˜…æ¶ˆæ¯çš„åŠŸèƒ½ï¼ˆæ´»åŠ¨å¼€å§‹æ—¶ï¼‰
- [ ] å¤„ç†å¾®ä¿¡ API é”™è¯¯ç ï¼Œæ›´æ–°æˆæƒçŠ¶æ€

### 6.3 æµ‹è¯•éªŒè¯

#### å‰ç«¯æµ‹è¯•

- [ ] é¦–æ¬¡ç‚¹å‡» DIY åˆ›ä½œï¼ŒéªŒè¯å¼¹å‡ºæˆæƒå¼¹çª—
- [ ] åŒæ„æˆæƒï¼ŒéªŒè¯æœ¬åœ°æ ‡è®°å·²ä¿å­˜
- [ ] å†æ¬¡ç‚¹å‡»ï¼ŒéªŒè¯ä¸å†å¼¹çª—
- [ ] éªŒè¯æˆæƒç»“æœå·²ä¸ŠæŠ¥åˆ°åç«¯

#### åç«¯æµ‹è¯•

- [ ] éªŒè¯æˆæƒæ•°æ®å·²æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
- [ ] æ¨¡æ‹Ÿæ–°å“ä¸Šæ¶ï¼ŒéªŒè¯æ¶ˆæ¯å‘é€æˆåŠŸ
- [ ] éªŒè¯ä¸€æ¬¡æ€§æˆæƒå‘é€åçŠ¶æ€æ›´æ–°ä¸º `consumed`
- [ ] éªŒè¯é•¿æœŸæˆæƒå¯ä»¥åå¤å‘é€

---

## 7. é¢„æœŸæ•ˆæœ

### 7.1 å‰ç«¯æ•ˆæœ

1. âœ… å°ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨æŸ¥è¯¢æˆæƒçŠ¶æ€ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
2. âœ… æˆæƒæœªæ¶ˆè´¹æ—¶ï¼Œç‚¹å‡»DIYç›´æ¥è·³è½¬ï¼Œä½“éªŒæµç•…
3. âœ… æˆæƒå·²æ¶ˆè´¹æ—¶ï¼Œæ™ºèƒ½å¼¹å‡ºé‡æ–°æˆæƒï¼Œç¡®ä¿èƒ½æ”¶åˆ°åç»­é€šçŸ¥
4. âœ… æˆæƒçŠ¶æ€å®æ—¶åŒæ­¥åˆ°åç«¯
5. âœ… æ— è®ºæˆæƒç»“æœå¦‚ä½•ï¼Œéƒ½èƒ½æ­£å¸¸è·³è½¬åˆ° DIY é¡µé¢

### 7.2 è§£å†³çš„æ ¸å¿ƒé—®é¢˜

**ä¸€æ¬¡æ€§è®¢é˜…çš„ç—›ç‚¹**ï¼š
- âŒ æ—§æ–¹æ¡ˆï¼šç”¨æˆ·æˆæƒä¸€æ¬¡åï¼Œæ°¸è¿œä¸ä¼šå†è¯·æ±‚æˆæƒ
- âŒ ç»“æœï¼šæ¶ˆæ¯å‘é€ä¸€æ¬¡åï¼Œç”¨æˆ·å†ä¹Ÿæ”¶ä¸åˆ°é€šçŸ¥

**æ–°æ–¹æ¡ˆçš„ä¼˜åŠ¿**ï¼š
- âœ… å¯åŠ¨æ—¶æŸ¥è¯¢çœŸå®çŠ¶æ€ï¼Œä¸åç«¯æ•°æ®åº“åŒæ­¥
- âœ… æˆæƒæ¶ˆè´¹åè‡ªåŠ¨é‡æ–°è¯·æ±‚
- âœ… ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œä½“éªŒæµç•…ï¼ˆå¯åŠ¨æ—¶æŸ¥è¯¢ï¼‰

### 7.3 åç«¯æ•ˆæœ

1. âœ… ç»´æŠ¤ç”¨æˆ·è®¢é˜…æˆæƒçŠ¶æ€
2. âœ… åœ¨æ–°å“ä¸Šæ¶æˆ–æ´»åŠ¨å¼€å§‹æ—¶ï¼Œå‘å·²æˆæƒç”¨æˆ·å‘é€è®¢é˜…æ¶ˆæ¯
3. âœ… è‡ªåŠ¨å¤„ç†æˆæƒæ¶ˆè´¹å’Œè¿‡æœŸçŠ¶æ€
4. âœ… å‡å°‘æ— æ•ˆ API è°ƒç”¨ï¼Œæå‡ç³»ç»Ÿæ•ˆç‡

---

## 8. å‚è€ƒèµ„æ–™

- [å¾®ä¿¡å°ç¨‹åºè®¢é˜…æ¶ˆæ¯æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)
- [Taro æœ¬åœ°å­˜å‚¨ API](https://taro-docs.jd.com/docs/apis/storage/setStorageSync)
- é¡¹ç›®å†…éƒ¨å·¥å…·ï¼š`src/utils/messageUtils.ts`

---

**æ–‡æ¡£ç»´æŠ¤**: å¦‚æœ‰é—®é¢˜æˆ–éœ€è¦æ›´æ–°ï¼Œè¯·è”ç³»å‰ç«¯å›¢é˜Ÿ

